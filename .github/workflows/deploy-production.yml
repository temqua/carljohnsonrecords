name: Deploy to production

on:
  push:
    branches:
      - main

jobs:
  compress:
    runs-on: debian-latest
    steps:
      - name: Compress build into .tgz file
        run: tar --exclude=".[^/]*" -czf ./cj-release.tgz .

  upload:
    runs-on: debian-latest
    steps:
      - name: upload to production via SSH
      - uses: marcodallasanta/ssh-scp-deploy@v1.0.5
        with:
          local: cj-release.tgz
          remote: /site/cj-release.tgz
          host: ${{secrets.SSH_HOST_PROD}}
          user: ${{secrets.SSH_USER_PROD}}
          key: ${{secrets.SSH_PRIVATE_KEY_PROD}}
          post_upload: tar -xzf /site/cj-release.tgz . &&
            rm /site/cj-release.tgz

      - name: start docker
      - uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST_PROD }}
          username: ${{ secrets.SSH_USER_PROD }}
          key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}
          port: 22
          script_stop: true
          script: |
            cd /site
            docker build -t cjsite  .
            docker stop cjsite || true
            docker rm cjsite || true
            docker run -d -p 8080:8080 --name cjsite --restart always cjsite
